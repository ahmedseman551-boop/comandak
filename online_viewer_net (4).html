<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙƒÙˆÙ…Ø§Ù†Ø¯Ùƒ - Komandk</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #121212; color: white; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; padding-bottom: 70px; }
        .container { max-width: 450px; margin: auto; padding: 20px; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-section { 
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                        url('https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80');
            background-size: cover; background-position: center;
        }
        .auth-box { background: rgba(30, 30, 30, 0.9); padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { color: #888; text-align: center; cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item i { font-size: 20px; display: block; }
        .nav-item span { font-size: 12px; }
        .nav-item.active { color: #ffca28; }

        /* Ø§Ù„ØµÙØ­Ø§Øª */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .restaurant-card { background: #1e1e1e; border-radius: 15px; margin-bottom: 25px; border: 1px solid #333; overflow: hidden; text-align: right; }
        .res-img { width: 100%; height: 150px; object-fit: cover; }
        .res-content { padding: 15px; }
        
        /* Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
        .rating-box { margin: 5px 0; direction: ltr; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }
        .star { font-size: 18px; cursor: pointer; color: #444; }
        .star.active { color: #ffca28; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .order-btn { display: block; background: #2ecc71; color: white; padding: 10px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold; margin-bottom: 8px; }
        .menu-btn { width: 100%; padding: 10px; background: none; color: #ffca28; border: 1px solid #ffca28; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        .map-container { width: 100%; height: 80vh; border-radius: 15px; overflow: hidden; border: 1px solid #333; }
        
        /* Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
        .profile-box { background: #1e1e1e; padding: 20px; border-radius: 15px; text-align: center; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #333; }
        select { background: #2a2a2a; color: white; border: 1px solid #444; padding: 5px; border-radius: 5px; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); overflow-y: auto; }
        .modal-content { background: #1e1e1e; margin: 10% auto; padding: 20px; width: 85%; max-width: 400px; border-radius: 20px; position: relative; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; background: #2a2a2a; color: white; text-align: center; }
    </style>
</head>
<body>

<div id="auth-section">
    <div class="auth-box">
        <h1 style="color:#ffca28; margin-bottom:5px;">ÙƒÙˆÙ…Ø§Ù†Ø¯Ùƒ</h1>
        <p style="color:#eee; margin-bottom:20px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙƒÙˆÙ…Ø§Ù†Ø¯Ùƒ</p>
        <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="login()" style="width:100%; background:#ffca28; padding:12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">Ø¯Ø®ÙˆÙ„</button>
        <button onclick="guestLogin()" style="background:none; color:#aaa; border:none; margin-top:15px; cursor:pointer;">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ</button>
    </div>
</div>

<div id="app-content" style="display:none;">
    <div id="homePage" class="page active container">
        <h2 id="homeTitle" style="color:#ffca28; text-align:right;">ğŸ“ Ù…Ø·Ø§Ø¹Ù…Ù†Ø§</h2>
        <div id="restaurant-list">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div id="mapPage" class="page container">
        <h2 id="mapTitle" style="color:#ffca28; text-align:right;">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h2>
        <div class="map-container">
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3856.892!2d-15.965!3d18.085!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMTjCsDA1JzA2LjAiTiAxNcKwNTcnNTQuMCJX!5e0!3m2!1sen!2smr!4v1620000000000!5m2!1sen!2smr" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
        </div>
    </div>

    <div id="profilePage" class="page container">
        <h2 id="profileTitle" style="color:#ffca28; text-align:right;">ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</h2>
        <div class="profile-box">
            <i class="fas fa-user-circle" style="font-size: 60px; color: #ffca28; margin-bottom: 10px;"></i>
            <h3 id="userDisplayName">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h3>
            <div class="settings-item">
                <span id="langText">Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
                <select id="langSelect" onchange="changeLanguage()">
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="fr">FranÃ§ais</option>
                </select>
            </div>
            <button id="logoutBtn" onclick="logout()" style="width:100%; background:#ff4444; color:white; border:none; padding:12px; border-radius:10px; margin-top:20px; font-weight:bold;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" id="navHome" onclick="showPage('homePage', 'navHome')">
            <i class="fas fa-home"></i>
            <span id="navHomeText">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <div class="nav-item" id="navMap" onclick="showPage('mapPage', 'navMap')">
            <i class="fas fa-map-marked-alt"></i>
            <span id="navMapText">Ø§Ù„Ø®Ø±ÙŠØ·Ø©</span>
        </div>
        <div class="nav-item" id="navProfile" onclick="showPage('profilePage', 'navProfile')">
            <i class="fas fa-user"></i>
            <span id="navProfileText">Ø­Ø³Ø§Ø¨ÙŠ</span>
        </div>
    </div>
</div>

<div id="menuModal" class="modal"><div id="modalBody" class="modal-content"></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCo-hsHKkHfdUx0mykhtQh1KU-AUcbINAA",
      authDomain: "nouakchott-food-20769.firebaseapp.com",
      projectId: "nouakchott-food-20769",
      storageBucket: "nouakchott-food-20769.firebasestorage.app",
      messagingSenderId: "392796155801",
      appId: "1:392796155801:web:c1301535ac536f4e01ad08"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.login = async () => {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        try { await signInWithEmailAndPassword(auth, `${u}@app.com`, p); } 
        catch { await createUserWithEmailAndPassword(auth, `${u}@app.com`, p); }
    };
    window.guestLogin = () => signInAnonymously(auth);
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, user => {
        document.getElementById('auth-section').style.display = user ? 'none' : 'flex';
        document.getElementById('app-content').style.display = user ? 'block' : 'none';
        if(user) {
            document.getElementById('userDisplayName').innerText = user.isAnonymous ? "Ø¶ÙŠÙ ÙƒÙˆÙ…Ø§Ù†Ø¯Ùƒ" : user.email.split('@')[0];
            loadData();
        }
    });

    window.showPage = (pageId, navId) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.getElementById(navId).classList.add('active');
    };

    window.changeLanguage = () => {
        const lang = document.getElementById('langSelect').value;
        const isFr = lang === 'fr';
        document.dir = isFr ? 'ltr' : 'rtl';
        document.getElementById('navHomeText').innerText = isFr ? "Home" : "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©";
        document.getElementById('navMapText').innerText = isFr ? "Map" : "Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
        document.getElementById('navProfileText').innerText = isFr ? "Account" : "Ø­Ø³Ø§Ø¨ÙŠ";
        document.getElementById('homeTitle').innerText = isFr ? "ğŸ“ Restaurants" : "ğŸ“ Ù…Ø·Ø§Ø¹Ù…Ù†Ø§";
        document.getElementById('mapTitle').innerText = isFr ? "ğŸ—ºï¸ Map" : "ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
        document.getElementById('profileTitle').innerText = isFr ? "ğŸ‘¤ Account" : "ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ";
        document.getElementById('langText').innerText = isFr ? "Language" : "Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚";
        document.getElementById('logoutBtn').innerText = isFr ? "Logout" : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬";
    };

    function loadData() {
        onSnapshot(collection(db, "restaurants"), (snap) => {
            const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
            displayRestaurants(data);
        });
    }

    const fixUrl = (url) => url && url.startsWith('http') ? `${url}?t=${new Date().getTime()}` : 'https://via.placeholder.com/400x200';

    window.displayRestaurants = (data) => {
        const list = document.getElementById('restaurant-list');
        list.innerHTML = data.map(res => {
            const avg = res.rating_count ? Math.round(res.total_stars / res.rating_count) : 0;
            const waLink = `https://wa.me/${res.phone}?text=${encodeURIComponent('Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… Ø£Ø±ÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù…Ø·Ø¹Ù… ' + res.name)}`;
            return `
                <div class="restaurant-card">
                    <img src="${fixUrl(res.image)}" class="res-img">
                    <div class="res-content">
                        <p class="res-name" style="font-size:20px; font-weight:bold; margin:0;">${res.name}</p>
                        <div class="rating-box">
                            ${[5,4,3,2,1].map(n => `<span class="star ${n <= avg ? 'active' : ''}" onclick="rate('${res.id}', ${n})">â˜…</span>`).join('')}
                        </div>
                        <a href="${waLink}" target="_blank" class="order-btn">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</a>
                        <button class="menu-btn" onclick='showMenu(${JSON.stringify(res)})'>Ø§Ù„Ù…Ù†ÙŠÙˆ ÙˆØ§Ù„Ø£ØµÙ†Ø§Ù</button>
                    </div>
                </div>`;
        }).join('');
    };

    window.rate = async (id, s) => {
        await updateDoc(doc(db, "restaurants", id), { total_stars: increment(s), rating_count: increment(1) });
    };

    window.showMenu = (res) => {
        const body = document.getElementById('modalBody');
        let imgs = res.menu_image ? `<img src="${fixUrl(res.menu_image)}" style="width:100%; border-radius:10px;">` : '';
        if(Array.isArray(res.extra_image)) res.extra_image.forEach(i => imgs += `<img src="${fixUrl(i)}" style="width:100%; margin-top:10px; border-radius:10px;">`);
        body.innerHTML = `<span style="float:left; cursor:pointer; font-size:24px;" onclick="document.getElementById('menuModal').style.display='none'">Ã—</span>
                          <h3>${res.name}</h3><div style="margin-top:20px;">${imgs}</div>`;
        document.getElementById('menuModal').style.display = 'block';
    };
</script>
</body>
</html>
